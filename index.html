<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8' />
        <title>An example of snow-tweets</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.24.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.24.0/mapbox-gl.css' rel='stylesheet' />
        <style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width:100%; }
        </style>
    </head>
    <body>
        <style>
            /*
            .popup { text-align:center; }
            .popup .slideshow .image { display:none; }
            .popup .slideshow .image.active { display:block; }
            .popup .slideshow img { width:100%; }
            .popup .slideshow .caption {
                background:#eee;
                pagging:10px;
            }
            .popup .cycle { padding:10px  0 20px; }
            .popup .cycle a.prev { float:left; }
            .popup .cycle a.next { float:right; }
            */
        </style>
        
        <div id='map'></div>
        <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoibTlicmFkeSIsImEiOiJjaXNzNHQ0YmowNmM5MnlwaGh3YjJzd3k3In0.-Fu9YD8Qbrw7xRZ-7Ocn6w';
            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/mapbox/dark-v9', //stylesheet location
                center: [-79.50, 44], // starting position
                zoom: 3, // starting zoom
                dragRotate: false // no rotation
            });
            var data_url = 'mapbox://m9brady.cisum4gbe0ey52utkxmrua7di-35xnn';
            map.on('load', function() {
                /*
                window.setInterval(function() {
                    map.getSource('tweet-data').setData(data_url);
                }, 10000);  
                */
                map.addSource('tweet-data', {
                    type: 'vector',
                    url: data_url,
                    cluster: true,
                    clusterMaxZoom: 11,
                    clusterRadius: 50
                });
                // going to create 5 layers total:
                // 1 for single points
                // 3 for varying cluster densities
                // 1 for cluster label text
                map.addLayer({
                    "id": "snowtweets",
                    "type": "symbol",
                    "source": "tweet-data",
                    "source-layer": "snowtweets",
                    "layout": {
                        "icon-image": "marker-15"
                    }
                });
                
                var layers = [
                    [150, '#f28cb1'],
                    [20, '#f1f075'],
                    [0,'#51bbd6']
                ];
                
                layers.forEach(function (layer, i) {
                    map.addLayer({
                        "id":"cluster-" + i,
                        "type": "circle",
                        "source": "tweet-data",
                        "paint": {
                            "circle-color": layer[1],
                            "circle-radius":18
                        },
                        "filter": i === 0 ?
                            [">=", "point_count", layer[0]] :
                            ["all", 
                                [">=", "point_count", layer[0]],
                                ["<", "point_count", layers[i - 1][0]]]
                    });
                 });
                             
                 // cluster count label
                 map.addLayer({
                    "id": "cluster-count",
                    "type": "symbol",
                    "source": "tweet-data",
                    "layout": {
                        "text-field": "{point_count}",
                        "text-font": [
                             "DIN Offc Pro Medium",
                             "Arial Unicode MS Bold"
                        ],
                        "text-size": 12
                    }
                }); 
            });
                
            map.on('click', function (e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['snowtweets'] });
                if (!features.length) {
                    return;
                }
                var feature = features[0];
                // Populate the popup and set its coordinates
                // based on the feature found.
                var popup = new mapboxgl.Popup({closeButton:false})
                    .setLngLat(feature.geometry.coordinates)
                    //.setHTML("<b>"+feature.properties.twitter_handle+"</b><br><i>"+feature.properties.tweet_text+"</i><br><iframe src='"+feature.properties.media_url+"/embed/' alt='tweet image' width='100',height='100'>")
                    //.setHTML("<br><b>"+feature.properties.twitter_handle+"</b><br><i>"+feature.properties.tweet_text+"</i><br>")
                    .setHTML("<b>"+feature.properties.twitter_handle+"</b><p>"+feature.properties.tweet_text+"</p><p><i>"+feature.properties.media_url+"</i></p>")
                    .addTo(map);
            });
            map.on('mousemove', function (e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['snowtweets'] });
                map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
            });
        </script>
    </body>
</html>
